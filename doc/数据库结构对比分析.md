# 数据库结构对比分析

## 📋 概述

本文档对比了Supabase数据库结构和本地TypeScript类型定义，识别差异并提供解决方案。

## 🔍 结构对比

### 1. 用户资料表 (profiles)

#### ✅ 完全匹配
| 字段 | 数据库类型 | 本地类型 | 状态 |
|------|------------|----------|------|
| id | UUID | string | ✅ |
| username | VARCHAR(50) | string | ✅ |
| display_name | TEXT | string \| null | ✅ |
| avatar_url | TEXT | string \| null | ✅ |
| bio | TEXT | string \| null | ✅ |
| level | INTEGER | number | ✅ |
| experience | INTEGER | number | ✅ |
| streak_days | INTEGER | number | ✅ |
| last_active_at | TIMESTAMP | string | ✅ |
| created_at | TIMESTAMP | string | ✅ |
| updated_at | TIMESTAMP | string | ✅ |

### 2. Feed卡片表 (feed_cards)

#### ⚠️ 部分匹配 - 需要更新

**数据库结构：**
```sql
CREATE TABLE public.feed_cards (
  id UUID PRIMARY KEY,
  type VARCHAR(20) CHECK (type IN ('novel', 'text', 'image', 'video', 'audio', 'ad')),
  title TEXT,
  content JSONB,
  author_id UUID,
  likes_count INTEGER,
  comments_count INTEGER,
  shares_count INTEGER,
  views_count INTEGER,
  visibility VARCHAR(20),
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

**本地类型定义：**
```typescript
export type FeedCardType = 'novel' | 'text' | 'media' | 'audio' | 'ad' | 'quote' | 'repost';
```

#### 🚨 差异分析：

1. **类型不匹配：**
   - 数据库：`'novel', 'text', 'image', 'video', 'audio', 'ad'`
   - 本地：`'novel', 'text', 'media', 'audio', 'ad', 'quote', 'repost'`
   - 差异：缺少 `quote`, `repost` 类型，缺少 `image`, `video` 分离

2. **字段缺失：**
   - 数据库缺少：`difficulty`, `tags`, `metadata`
   - 本地类型缺少：`title` 字段

### 3. 交互表 (interactions)

#### ❌ 不匹配 - 需要重构

**数据库结构：**
```sql
CREATE TABLE public.interactions (
  id UUID PRIMARY KEY,
  user_id UUID,
  target_id UUID,
  target_type VARCHAR(20) CHECK (target_type IN ('card', 'comment')),
  type VARCHAR(20) CHECK (type IN ('like', 'comment', 'share', 'bookmark')),
  content TEXT
);
```

**本地类型定义：**
```typescript
export type InteractionType = 'like' | 'unlike' | 'repost' | 'unrepost' | 'bookmark' | 'unbookmark' | 'reply' | 'quote' | 'share';
```

#### 🚨 差异分析：

1. **类型不匹配：**
   - 数据库：`'like', 'comment', 'share', 'bookmark'`
   - 本地：`'like', 'unlike', 'repost', 'unrepost', 'bookmark', 'unbookmark', 'reply', 'quote', 'share'`
   - 差异：数据库缺少 `unlike`, `repost`, `unrepost`, `unbookmark`, `reply`, `quote` 类型

2. **设计理念差异：**
   - 数据库：简单状态存储
   - 本地：复杂交互状态管理

## 🛠️ 解决方案

### 方案1：更新数据库结构（推荐）

#### 1. 更新Feed卡片表
```sql
-- 添加缺失字段
ALTER TABLE public.feed_cards 
ADD COLUMN difficulty INTEGER CHECK (difficulty BETWEEN 1 AND 5),
ADD COLUMN tags TEXT[],
ADD COLUMN metadata JSONB DEFAULT '{}'::jsonb;

-- 更新类型约束
ALTER TABLE public.feed_cards 
DROP CONSTRAINT IF EXISTS feed_cards_type_check;

ALTER TABLE public.feed_cards 
ADD CONSTRAINT feed_cards_type_check 
CHECK (type IN ('novel', 'text', 'image', 'video', 'audio', 'ad', 'quote', 'repost'));
```

#### 2. 更新交互表
```sql
-- 更新类型约束
ALTER TABLE public.interactions 
DROP CONSTRAINT IF EXISTS interactions_type_check;

ALTER TABLE public.interactions 
ADD CONSTRAINT interactions_type_check 
CHECK (type IN ('like', 'unlike', 'comment', 'reply', 'share', 'repost', 'unrepost', 'bookmark', 'unbookmark', 'quote'));
```

### 方案2：更新本地类型定义

#### 1. 更新Feed类型
```typescript
// src/types/feed.ts
export type FeedCardType = 
  | 'novel' 
  | 'text' 
  | 'image'      // 从数据库
  | 'video'      // 从数据库
  | 'audio' 
  | 'ad'
  | 'quote'      // 需要数据库支持
  | 'repost';    // 需要数据库支持
```

#### 2. 更新交互类型
```typescript
// src/types/feed.ts
export type InteractionType = 
  | 'like'
  | 'comment'    // 从数据库
  | 'share'
  | 'bookmark'
  | 'reply'      // 需要数据库支持
  | 'quote'      // 需要数据库支持
  | 'repost';    // 需要数据库支持
```

## 📊 影响评估

### 高影响差异
1. **Feed卡片类型不匹配** - 影响内容创建和显示
2. **交互类型不匹配** - 影响用户互动功能

### 中影响差异
1. **字段缺失** - 影响功能完整性
2. **类型约束** - 影响数据验证

### 低影响差异
1. **命名差异** - 影响代码可读性
2. **结构差异** - 影响API设计

## 🎯 推荐行动

### 立即行动
1. **更新数据库迁移文件** - 添加缺失字段和类型
2. **更新本地类型定义** - 保持一致性
3. **更新API接口** - 支持新的数据结构

### 后续优化
1. **性能优化** - 添加必要的索引
2. **数据验证** - 加强约束条件
3. **API文档** - 更新接口文档

## 📝 实施计划

### 阶段1：数据库更新
- [ ] 创建新的迁移文件
- [ ] 添加缺失字段
- [ ] 更新类型约束
- [ ] 测试数据库更新

### 阶段2：类型定义更新
- [ ] 更新本地类型定义
- [ ] 更新API接口
- [ ] 更新组件类型
- [ ] 测试类型兼容性

### 阶段3：功能测试
- [ ] 测试内容创建
- [ ] 测试用户互动
- [ ] 测试数据查询
- [ ] 性能测试

## 🔧 技术细节

### 数据库迁移示例
```sql
-- 添加新字段
ALTER TABLE public.feed_cards 
ADD COLUMN difficulty INTEGER CHECK (difficulty BETWEEN 1 AND 5),
ADD COLUMN tags TEXT[],
ADD COLUMN metadata JSONB DEFAULT '{}'::jsonb;

-- 更新类型约束
ALTER TABLE public.feed_cards 
DROP CONSTRAINT IF EXISTS feed_cards_type_check;

ALTER TABLE public.feed_cards 
ADD CONSTRAINT feed_cards_type_check 
CHECK (type IN ('novel', 'text', 'image', 'video', 'audio', 'ad', 'quote', 'repost'));
```

### 类型定义更新示例
```typescript
// 更新Feed卡片类型
export interface FeedCard {
  id: string;
  type: FeedCardType;
  title?: string;        // 新增
  content: Json;
  author_id: string;
  difficulty?: number;   // 新增
  tags?: string[];       // 新增
  metadata?: Json;       // 新增
  likes_count: number;
  comments_count: number;
  shares_count: number;
  views_count: number;
  visibility: string;
  created_at: string;
  updated_at: string;
}
```

## 📈 总结

通过对比分析，发现数据库结构和本地类型定义存在显著差异。建议采用**方案1**（更新数据库结构），因为：

1. **功能完整性** - 支持所有计划的功能
2. **扩展性** - 为未来功能预留空间
3. **一致性** - 保持前后端数据结构一致
4. **维护性** - 减少类型转换的复杂性

实施后，将实现数据库结构和本地类型定义的完全匹配，为项目提供坚实的数据基础。
