# åç«¯ API å¿«é€Ÿå‚è€ƒ

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### æ•°æ®æµè½¬
```
å‰ç«¯ç±»å‹ â†’ DTO â†’ æ•°æ®åº“å­—æ®µ
FeedCard â†’ FeedCardDTO â†’ feed_cards (snake_case)
```

### å­—æ®µå‘½åè§„åˆ™
- **æ•°æ®åº“**: `snake_case` (author_id, created_at)
- **DTO**: `camelCase` (authorId, createdAt)
- **å‰ç«¯**: `camelCase` (authorId, createdAt)

## ğŸ“¡ API ç«¯ç‚¹é€ŸæŸ¥

### Feed æµ
```
GET    /api/feed              # è·å– Feed æµ
GET    /api/feed/:id          # è·å–å¡ç‰‡è¯¦æƒ…
POST   /api/feed              # åˆ›å»ºå¡ç‰‡ [éœ€è®¤è¯]
PUT    /api/feed/:id          # æ›´æ–°å¡ç‰‡ [éœ€è®¤è¯]
DELETE /api/feed/:id          # åˆ é™¤å¡ç‰‡ [éœ€è®¤è¯]
```

### äº’åŠ¨
```
POST   /api/interactions      # åˆ›å»ºäº’åŠ¨ [éœ€è®¤è¯]
DELETE /api/interactions      # åˆ é™¤äº’åŠ¨ [éœ€è®¤è¯]
```

### Quest
```
GET    /api/quests/:id        # è·å– Quest è¯¦æƒ…
POST   /api/quests/submit     # æäº¤ç­”æ¡ˆ [éœ€è®¤è¯]
```

### ç”¨æˆ·
```
GET    /api/users/:id         # è·å–ç”¨æˆ·èµ„æ–™
PUT    /api/users/:id         # æ›´æ–°ç”¨æˆ·èµ„æ–™ [éœ€è®¤è¯]
```

## ğŸ” è®¤è¯

### è¯·æ±‚å¤´
```http
Authorization: Bearer <token>
```

### è·å– Token
```typescript
const { data } = await supabase.auth.signInWithPassword({
  email: 'user@example.com',
  password: 'password'
});
const token = data.session?.access_token;
```

## ğŸ“¦ å“åº”æ ¼å¼

### æˆåŠŸ
```json
{
  "success": true,
  "data": { ... },
  "message": "æ“ä½œæˆåŠŸ",
  "timestamp": "2025-01-25T10:00:00.000Z"
}
```

### é”™è¯¯
```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "èµ„æºä¸å­˜åœ¨"
  },
  "timestamp": "2025-01-25T10:00:00.000Z"
}
```

### åˆ†é¡µ
```json
{
  "success": true,
  "data": {
    "items": [ ... ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "hasNext": true
    }
  }
}
```

## ğŸ—‚ï¸ æ ¸å¿ƒæ–‡ä»¶

### ç±»å‹å®šä¹‰
- `src/lib/api/types/response.ts` - å“åº”æ ¼å¼
- `src/lib/api/types/dto.ts` - æ•°æ®ä¼ è¾“å¯¹è±¡

### ä¸­é—´ä»¶
- `src/lib/api/middleware/auth.middleware.ts` - è®¤è¯
- `src/lib/api/middleware/cors.middleware.ts` - CORS
- `src/lib/api/middleware/error.middleware.ts` - é”™è¯¯å¤„ç†
- `src/lib/api/middleware/logger.middleware.ts` - æ—¥å¿—

### Service å±‚
- `src/lib/api/services/base.service.ts` - åŸºç¡€ Service
- `src/lib/api/services/feed.service.ts` - Feed ä¸šåŠ¡
- `src/lib/api/services/quest.service.ts` - Quest ä¸šåŠ¡
- `src/lib/api/services/interaction.service.ts` - äº’åŠ¨ä¸šåŠ¡
- `src/lib/api/services/user.service.ts` - ç”¨æˆ·ä¸šåŠ¡

### API è·¯ç”±
- `src/app/api/feed/route.ts` - Feed åˆ—è¡¨
- `src/app/api/feed/[id]/route.ts` - Feed è¯¦æƒ…
- `src/app/api/interactions/route.ts` - äº’åŠ¨
- `src/app/api/quests/[id]/route.ts` - Quest è¯¦æƒ…
- `src/app/api/quests/submit/route.ts` - æäº¤ç­”æ¡ˆ
- `src/app/api/users/[id]/route.ts` - ç”¨æˆ·èµ„æ–™

## ğŸ”„ æ•°æ®è½¬æ¢

### åˆ›å»ºå¡ç‰‡æµç¨‹
```typescript
// 1. å‰ç«¯æ•°æ®
const contentData = {
  category: 'quest',
  text: 'å­¦ä¹ å†…å®¹',
  questType: 'novel',
  difficulty: 3
};

// 2. è½¬æ¢ä¸º API è¯·æ±‚
const request = contentCreationToRequest(contentData);

// 3. Service å±‚å¤„ç†
const feedService = new FeedService();
const card = await feedService.createCard(userId, request);

// 4. è‡ªåŠ¨è½¬æ¢ä¸ºæ•°æ®åº“æ ¼å¼å¹¶æ’å…¥
// camelCase â†’ snake_case
```

### æŸ¥è¯¢å¡ç‰‡æµç¨‹
```typescript
// 1. ä»æ•°æ®åº“æŸ¥è¯¢ (snake_case)
const dbRow = { author_id: 'xxx', created_at: '...' };

// 2. è½¬æ¢ä¸º DTO (camelCase)
const dto = dbFieldToDto<FeedCardDTO>(dbRow);

// 3. è½¬æ¢ä¸ºå‰ç«¯ç±»å‹
const feedCard = feedCardDtoToFeedCard(dto);

// 4. è¿”å›ç»™å‰ç«¯
return createSuccessResponse(feedCard);
```

## ğŸ› ï¸ å¸¸ç”¨å·¥å…·å‡½æ•°

### å­—æ®µè½¬æ¢
```typescript
// æ•°æ®åº“ â†’ DTO
const dto = dbFieldToDto<FeedCardDTO>(dbRow);

// DTO â†’ æ•°æ®åº“
const dbRow = dtoFieldToDb(dto);

// DTO â†’ å‰ç«¯ç±»å‹
const feedCard = feedCardDtoToFeedCard(dto);

// å‰ç«¯ â†’ API è¯·æ±‚
const request = contentCreationToRequest(data);
```

### å“åº”åˆ›å»º
```typescript
// æˆåŠŸå“åº”
createSuccessResponse(data, 'æ“ä½œæˆåŠŸ');

// é”™è¯¯å“åº”
createErrorResponse(ErrorCode.NOT_FOUND, 'èµ„æºä¸å­˜åœ¨');

// åˆ†é¡µå“åº”
createPaginatedResponse(items, page, pageSize, total);
```

## ğŸ”’ æƒé™æ£€æŸ¥

### åŸºç¡€æƒé™
```typescript
// æ‰€æœ‰ç™»å½•ç”¨æˆ·
const permissions = [
  'create_post',
  'create_quest',
  'edit_profile'
];
```

### æ£€æŸ¥æƒé™
```typescript
// åœ¨ Service ä¸­
requirePermission(authContext, 'create_quest');

// æ£€æŸ¥æ‰€æœ‰æƒ
requireOwnership(authContext, resourceOwnerId);
```

## ğŸ“Š æ•°æ®åº“è¡¨é€ŸæŸ¥

### feed_cards
```sql
type: novel | text | image | video | audio | ad | quote | repost
author_id: UUID
content: JSONB
metadata: JSONB
difficulty: INTEGER (1-5)
tags: TEXT[]
likes_count, comments_count, shares_count, views_count: INTEGER
```

### profiles
```sql
username: VARCHAR(50)
display_name, avatar_url, bio: TEXT
level, experience, streak_days: INTEGER
```

### quests
```sql
chapter_id: UUID
type: vocabulary | grammar | comprehension | speaking | writing
config: JSONB
passing_score: INTEGER (0-100)
time_limit: INTEGER (ç§’)
```

### interactions
```sql
user_id, target_id: UUID
target_type: card | comment | chapter | quest
type: like | comment | reply | share | repost | bookmark | quote
content: TEXT (è¯„è®ºå†…å®¹)
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### Web åº”ç”¨
```typescript
// è·å– Feed
const res = await fetch('/api/feed?page=1');
const data = await res.json();

// åˆ›å»ºå¸–å­
const res = await fetch('/api/feed', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({ ... })
});
```

### å¾®ä¿¡å°ç¨‹åº
```javascript
// è·å– Feed
wx.request({
  url: 'https://your-domain.vercel.app/api/feed',
  header: { 'Authorization': 'Bearer ' + token },
  success: (res) => console.log(res.data)
});

// ç‚¹èµ
wx.request({
  url: 'https://your-domain.vercel.app/api/interactions',
  method: 'POST',
  header: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + token
  },
  data: {
    targetId: cardId,
    targetType: 'card',
    type: 'like'
  }
});
```

## ğŸ“ é”™è¯¯ç 

| é”™è¯¯ç  | HTTP çŠ¶æ€ | è¯´æ˜ |
|--------|----------|------|
| `UNAUTHORIZED` | 401 | æœªè®¤è¯ |
| `FORBIDDEN` | 403 | æ— æƒé™ |
| `NOT_FOUND` | 404 | ä¸å­˜åœ¨ |
| `ALREADY_EXISTS` | 409 | å·²å­˜åœ¨ |
| `VALIDATION_ERROR` | 422 | éªŒè¯å¤±è´¥ |
| `INTERNAL_ERROR` | 500 | æœåŠ¡å™¨é”™è¯¯ |

## ğŸ¯ å…³é”®ç‚¹

1. âœ… **å­—æ®µå¯¹é½**: æ•°æ®åº“ (snake_case) â†” DTO (camelCase) â†” å‰ç«¯ (camelCase)
2. âœ… **ç»Ÿä¸€å“åº”**: æ‰€æœ‰ API è¿”å›ç»Ÿä¸€æ ¼å¼
3. âœ… **è‡ªåŠ¨è½¬æ¢**: `dbFieldToDto` å’Œ `dtoFieldToDb` è‡ªåŠ¨å¤„ç†
4. âœ… **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
5. âœ… **å¤šç«¯æ”¯æŒ**: Webã€å°ç¨‹åºã€App é€šç”¨
6. âœ… **æƒé™æ§åˆ¶**: è®¤è¯ + æƒé™æ£€æŸ¥
7. âœ… **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å“åº”
8. âœ… **æ—¥å¿—è®°å½•**: å®Œæ•´çš„è¯·æ±‚/å“åº”æ—¥å¿—

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [API æ–‡æ¡£](./APIæ–‡æ¡£.md) - å®Œæ•´çš„ API æ¥å£æ–‡æ¡£
- [åç«¯æ¶æ„æ€»ç»“](./åç«¯æ¶æ„æ€»ç»“.md) - è¯¦ç»†çš„æ¶æ„è®¾è®¡è¯´æ˜
- [æ•°æ®åº“ç»“æ„å¯¹æ¯”åˆ†æ](./æ•°æ®åº“ç»“æ„å¯¹æ¯”åˆ†æ.md) - æ•°æ®åº“å­—æ®µå¯¹é½è¯´æ˜

