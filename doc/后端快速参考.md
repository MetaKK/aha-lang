# 后端 API 快速参考

## 🎯 核心概念

### 数据流转
```
前端类型 → DTO → 数据库字段
FeedCard → FeedCardDTO → feed_cards (snake_case)
```

### 字段命名规则
- **数据库**: `snake_case` (author_id, created_at)
- **DTO**: `camelCase` (authorId, createdAt)
- **前端**: `camelCase` (authorId, createdAt)

## 📡 API 端点速查

### Feed 流
```
GET    /api/feed              # 获取 Feed 流
GET    /api/feed/:id          # 获取卡片详情
POST   /api/feed              # 创建卡片 [需认证]
PUT    /api/feed/:id          # 更新卡片 [需认证]
DELETE /api/feed/:id          # 删除卡片 [需认证]
```

### 互动
```
POST   /api/interactions      # 创建互动 [需认证]
DELETE /api/interactions      # 删除互动 [需认证]
```

### Quest
```
GET    /api/quests/:id        # 获取 Quest 详情
POST   /api/quests/submit     # 提交答案 [需认证]
```

### 用户
```
GET    /api/users/:id         # 获取用户资料
PUT    /api/users/:id         # 更新用户资料 [需认证]
```

## 🔐 认证

### 请求头
```http
Authorization: Bearer <token>
```

### 获取 Token
```typescript
const { data } = await supabase.auth.signInWithPassword({
  email: 'user@example.com',
  password: 'password'
});
const token = data.session?.access_token;
```

## 📦 响应格式

### 成功
```json
{
  "success": true,
  "data": { ... },
  "message": "操作成功",
  "timestamp": "2025-01-25T10:00:00.000Z"
}
```

### 错误
```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "资源不存在"
  },
  "timestamp": "2025-01-25T10:00:00.000Z"
}
```

### 分页
```json
{
  "success": true,
  "data": {
    "items": [ ... ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "hasNext": true
    }
  }
}
```

## 🗂️ 核心文件

### 类型定义
- `src/lib/api/types/response.ts` - 响应格式
- `src/lib/api/types/dto.ts` - 数据传输对象

### 中间件
- `src/lib/api/middleware/auth.middleware.ts` - 认证
- `src/lib/api/middleware/cors.middleware.ts` - CORS
- `src/lib/api/middleware/error.middleware.ts` - 错误处理
- `src/lib/api/middleware/logger.middleware.ts` - 日志

### Service 层
- `src/lib/api/services/base.service.ts` - 基础 Service
- `src/lib/api/services/feed.service.ts` - Feed 业务
- `src/lib/api/services/quest.service.ts` - Quest 业务
- `src/lib/api/services/interaction.service.ts` - 互动业务
- `src/lib/api/services/user.service.ts` - 用户业务

### API 路由
- `src/app/api/feed/route.ts` - Feed 列表
- `src/app/api/feed/[id]/route.ts` - Feed 详情
- `src/app/api/interactions/route.ts` - 互动
- `src/app/api/quests/[id]/route.ts` - Quest 详情
- `src/app/api/quests/submit/route.ts` - 提交答案
- `src/app/api/users/[id]/route.ts` - 用户资料

## 🔄 数据转换

### 创建卡片流程
```typescript
// 1. 前端数据
const contentData = {
  category: 'quest',
  text: '学习内容',
  questType: 'novel',
  difficulty: 3
};

// 2. 转换为 API 请求
const request = contentCreationToRequest(contentData);

// 3. Service 层处理
const feedService = new FeedService();
const card = await feedService.createCard(userId, request);

// 4. 自动转换为数据库格式并插入
// camelCase → snake_case
```

### 查询卡片流程
```typescript
// 1. 从数据库查询 (snake_case)
const dbRow = { author_id: 'xxx', created_at: '...' };

// 2. 转换为 DTO (camelCase)
const dto = dbFieldToDto<FeedCardDTO>(dbRow);

// 3. 转换为前端类型
const feedCard = feedCardDtoToFeedCard(dto);

// 4. 返回给前端
return createSuccessResponse(feedCard);
```

## 🛠️ 常用工具函数

### 字段转换
```typescript
// 数据库 → DTO
const dto = dbFieldToDto<FeedCardDTO>(dbRow);

// DTO → 数据库
const dbRow = dtoFieldToDb(dto);

// DTO → 前端类型
const feedCard = feedCardDtoToFeedCard(dto);

// 前端 → API 请求
const request = contentCreationToRequest(data);
```

### 响应创建
```typescript
// 成功响应
createSuccessResponse(data, '操作成功');

// 错误响应
createErrorResponse(ErrorCode.NOT_FOUND, '资源不存在');

// 分页响应
createPaginatedResponse(items, page, pageSize, total);
```

## 🔒 权限检查

### 基础权限
```typescript
// 所有登录用户
const permissions = [
  'create_post',
  'create_quest',
  'edit_profile'
];
```

### 检查权限
```typescript
// 在 Service 中
requirePermission(authContext, 'create_quest');

// 检查所有权
requireOwnership(authContext, resourceOwnerId);
```

## 📊 数据库表速查

### feed_cards
```sql
type: novel | text | image | video | audio | ad | quote | repost
author_id: UUID
content: JSONB
metadata: JSONB
difficulty: INTEGER (1-5)
tags: TEXT[]
likes_count, comments_count, shares_count, views_count: INTEGER
```

### profiles
```sql
username: VARCHAR(50)
display_name, avatar_url, bio: TEXT
level, experience, streak_days: INTEGER
```

### quests
```sql
chapter_id: UUID
type: vocabulary | grammar | comprehension | speaking | writing
config: JSONB
passing_score: INTEGER (0-100)
time_limit: INTEGER (秒)
```

### interactions
```sql
user_id, target_id: UUID
target_type: card | comment | chapter | quest
type: like | comment | reply | share | repost | bookmark | quote
content: TEXT (评论内容)
```

## 🚀 使用示例

### Web 应用
```typescript
// 获取 Feed
const res = await fetch('/api/feed?page=1');
const data = await res.json();

// 创建帖子
const res = await fetch('/api/feed', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({ ... })
});
```

### 微信小程序
```javascript
// 获取 Feed
wx.request({
  url: 'https://your-domain.vercel.app/api/feed',
  header: { 'Authorization': 'Bearer ' + token },
  success: (res) => console.log(res.data)
});

// 点赞
wx.request({
  url: 'https://your-domain.vercel.app/api/interactions',
  method: 'POST',
  header: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + token
  },
  data: {
    targetId: cardId,
    targetType: 'card',
    type: 'like'
  }
});
```

## 📝 错误码

| 错误码 | HTTP 状态 | 说明 |
|--------|----------|------|
| `UNAUTHORIZED` | 401 | 未认证 |
| `FORBIDDEN` | 403 | 无权限 |
| `NOT_FOUND` | 404 | 不存在 |
| `ALREADY_EXISTS` | 409 | 已存在 |
| `VALIDATION_ERROR` | 422 | 验证失败 |
| `INTERNAL_ERROR` | 500 | 服务器错误 |

## 🎯 关键点

1. ✅ **字段对齐**: 数据库 (snake_case) ↔ DTO (camelCase) ↔ 前端 (camelCase)
2. ✅ **统一响应**: 所有 API 返回统一格式
3. ✅ **自动转换**: `dbFieldToDto` 和 `dtoFieldToDb` 自动处理
4. ✅ **类型安全**: 完整的 TypeScript 类型定义
5. ✅ **多端支持**: Web、小程序、App 通用
6. ✅ **权限控制**: 认证 + 权限检查
7. ✅ **错误处理**: 统一的错误响应
8. ✅ **日志记录**: 完整的请求/响应日志

## 🔗 相关文档

- [API 文档](./API文档.md) - 完整的 API 接口文档
- [后端架构总结](./后端架构总结.md) - 详细的架构设计说明
- [数据库结构对比分析](./数据库结构对比分析.md) - 数据库字段对齐说明

