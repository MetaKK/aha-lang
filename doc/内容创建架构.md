# ğŸ“ å†…å®¹åˆ›å»ºæ¶æ„è®¾è®¡

## ğŸ¯ è®¾è®¡ç†å¿µ

### æ ¸å¿ƒåŸåˆ™
1. **ç®€åŒ–å…¥å£**ï¼šåªæœ‰ä¸¤ä¸ªæ ¸å¿ƒå…¥å£ - æ–°å¢å¸–å­å’Œæ–°å¢æŒ‘æˆ˜
2. **æ™ºèƒ½åˆ†å‘**ï¼šé€šè¿‡è§„åˆ™å¼•æ“è‡ªåŠ¨è¯†åˆ«å†…å®¹ç±»å‹
3. **ç»Ÿä¸€æ¥å£**ï¼šå‰ç«¯å’Œåç«¯ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®ç»“æ„
4. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢å†…å®¹ç±»å‹åªéœ€æ·»åŠ åˆ†å‘è§„åˆ™

### è®¾è®¡ä¼˜åŠ¿
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šç®€æ´ç›´è§‚ï¼Œé™ä½è®¤çŸ¥è´Ÿæ‹…
- âœ… **å¼€å‘æ•ˆç‡**ï¼šç»Ÿä¸€çš„ä»£ç ç»“æ„ï¼Œæ˜“äºç»´æŠ¤
- âœ… **å¯æ‰©å±•æ€§**ï¼šæ–°å¢ç±»å‹æ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘
- âœ… **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»FAB
    â†“
é€‰æ‹©ç±»åˆ«ï¼ˆå¸–å­/æŒ‘æˆ˜ï¼‰
    â†“
æ‰“å¼€ç»Ÿä¸€åˆ›å»ºæ¨¡æ€æ¡†
    â†“
è¾“å…¥å†…å®¹ï¼ˆæ–‡æœ¬+åª’ä½“+å…ƒæ•°æ®ï¼‰
    â†“
æäº¤ â†’ æ™ºèƒ½åˆ†å‘å™¨åˆ†æ
    â†“
ç¡®å®šå…·ä½“ç±»å‹ï¼ˆtext/media/novelç­‰ï¼‰
    â†“
è°ƒç”¨APIåˆ›å»ºå†…å®¹
    â†“
è¿”å›æ ‡å‡†åŒ–å“åº”
    â†“
Feedåˆ—è¡¨è‡ªåŠ¨åˆ·æ–°
```

### ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           UI Layer (è¡¨ç°å±‚)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ UnifiedFAB   â”‚  â”‚UnifiedCreateModalâ”‚ â”‚
â”‚  â”‚ (ä¸¤ä¸ªå…¥å£)    â”‚  â”‚  (åŠ¨æ€è¡¨å•)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Business Logic Layer (ä¸šåŠ¡å±‚)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    ContentDispatcher             â”‚   â”‚
â”‚  â”‚    (æ™ºèƒ½åˆ†å‘å™¨)                   â”‚   â”‚
â”‚  â”‚  - è§„åˆ™åŒ¹é…                       â”‚   â”‚
â”‚  â”‚  - ç±»å‹è¯†åˆ«                       â”‚   â”‚
â”‚  â”‚  - å…ƒæ•°æ®æå–                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Data Layer (æ•°æ®å±‚)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Content API  â”‚  â”‚  Feed API        â”‚ â”‚
â”‚  â”‚ (ç»Ÿä¸€æ¥å£)    â”‚  â”‚  (å…¼å®¹å±‚)         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â†“                    â†“           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Mock Storage â”‚  â”‚  Supabase        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. UnifiedFAB (ç»Ÿä¸€æµ®åŠ¨æŒ‰é’®)

**èŒè´£**ï¼š
- æä¾›ä¸¤ä¸ªæ ¸å¿ƒå…¥å£
- ä¼˜é›…çš„åŠ¨ç”»äº¤äº’
- æ¸…æ™°çš„è§†è§‰å±‚çº§

**ç‰¹ç‚¹**ï¼š
```typescript
<UnifiedFAB
  onCreatePost={() => {}}      // æ–°å¢å¸–å­
  onCreateChallenge={() => {}} // æ–°å¢æŒ‘æˆ˜
/>
```

**è®¾è®¡äº®ç‚¹**ï¼š
- å¡ç‰‡å¼å±•å¼€èœå•
- æ¯ä¸ªé€‰é¡¹æœ‰å›¾æ ‡+æ ‡é¢˜+æè¿°
- æµç•…çš„åŠ¨ç”»æ•ˆæœ

### 2. UnifiedCreateModal (ç»Ÿä¸€åˆ›å»ºæ¨¡æ€æ¡†)

**èŒè´£**ï¼š
- æ ¹æ®ç±»åˆ«åŠ¨æ€è°ƒæ•´UI
- æ”¶é›†ç”¨æˆ·è¾“å…¥
- æä¾›é«˜çº§é€‰é¡¹

**ç‰¹ç‚¹**ï¼š
```typescript
<UnifiedCreateModal
  isOpen={true}
  category="post"  // æˆ– "challenge"
  onClose={() => {}}
  onSubmit={async (data) => {}}
/>
```

**åŠ¨æ€UI**ï¼š
- **å¸–å­æ¨¡å¼**ï¼šç®€æ´è¡¨å•ï¼Œ280å­—é™åˆ¶
- **æŒ‘æˆ˜æ¨¡å¼**ï¼šæ‰©å±•è¡¨å•ï¼Œéš¾åº¦é€‰æ‹©ï¼Œé¢„è®¡æ—¶é•¿

### 3. ContentDispatcher (æ™ºèƒ½åˆ†å‘å™¨)

**èŒè´£**ï¼š
- åˆ†æå†…å®¹ç‰¹å¾
- åŒ¹é…åˆ†å‘è§„åˆ™
- è¿”å›å»ºè®®ç±»å‹

**è§„åˆ™å¼•æ“**ï¼š
```typescript
// ç¤ºä¾‹è§„åˆ™
{
  id: 'post-media-detection',
  priority: 100,
  condition: (data) => data.media?.length > 0,
  action: (data) => ({
    suggestedType: 'media',
    confidence: 0.95,
    reasons: ['åŒ…å«åª’ä½“å†…å®¹']
  })
}
```

**åˆ†å‘é€»è¾‘**ï¼š
1. æŒ‰ä¼˜å…ˆçº§æ’åºè§„åˆ™
2. ä¾æ¬¡æ‰§è¡Œæ¡ä»¶åˆ¤æ–­
3. è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…çš„ç»“æœ
4. æ— åŒ¹é…åˆ™ä½¿ç”¨é»˜è®¤ç±»å‹

---

## ğŸ”„ æ•°æ®æµ

### åˆ›å»ºå¸–å­æµç¨‹

```typescript
// 1. ç”¨æˆ·è¾“å…¥
{
  text: "Hello World!",
  media: [{ type: 'image', url: '...' }],
  metadata: {}
}

// 2. æ™ºèƒ½åˆ†æ
ContentDispatcher.analyze({
  category: 'post',
  text: "Hello World!",
  media: [...]
})

// 3. åˆ†æç»“æœ
{
  category: 'post',
  suggestedType: 'media',  // å› ä¸ºåŒ…å«å›¾ç‰‡
  confidence: 0.95,
  reasons: ['åŒ…å«å›¾ç‰‡å†…å®¹'],
  metadata: {
    mediaCount: 1,
    mediaTypes: ['image']
  }
}

// 4. APIè°ƒç”¨
createPost({
  text: "Hello World!",
  media: [...]
})

// 5. è¿”å›å“åº”
{
  id: 'post-123',
  category: 'post',
  type: 'media',
  content: { ... },
  author: { ... },
  createdAt: '2025-01-25T...',
  analysis: { ... }
}
```

### åˆ›å»ºæŒ‘æˆ˜æµç¨‹

```typescript
// 1. ç”¨æˆ·è¾“å…¥
{
  text: "Learn Harry Potter Chapter 1",
  media: [],
  metadata: {
    difficulty: 3,
    estimatedTime: '30åˆ†é’Ÿ',
    tags: ['Fantasy', 'British English']
  }
}

// 2. æ™ºèƒ½åˆ†æ
ContentDispatcher.analyze({
  category: 'challenge',
  text: "...",
  metadata: { ... }
})

// 3. åˆ†æç»“æœ
{
  category: 'challenge',
  suggestedType: 'novel',  // è¯†åˆ«ä¸ºå°è¯´æŒ‘æˆ˜
  confidence: 0.98,
  reasons: ['åŒ…å«å°è¯´ç›¸å…³å…³é”®è¯'],
  metadata: {
    difficulty: 3,
    estimatedTime: '30åˆ†é’Ÿ'
  }
}

// 4. APIè°ƒç”¨
createChallenge({
  text: "...",
  challengeType: 'novel',
  difficulty: 3,
  ...
})

// 5. è¿”å›å“åº” + è‡ªåŠ¨è½¬æ¢ä¸ºFeedCard
```

---

## ğŸ¨ å¡ç‰‡æ¸²æŸ“

### æ¸²æŸ“ç­–ç•¥

```typescript
// PostCardå·¥å‚æ¨¡å¼
function PostCard({ card }) {
  switch (card.type) {
    case 'text':
      return <TextCard card={card} />;
    case 'media':
      return <MediaCard card={card} />;
    case 'audio':
      return <MediaCard card={card} />;
    case 'novel':
      return <QuestCard card={card} />;
    case 'chapter':
      return <ChapterCard card={card} />;
    default:
      return <TextCard card={card} />;
  }
}
```

### ç±»å‹æ˜ å°„

| å†…å®¹ç±»åˆ« | å­ç±»å‹ | æ¸²æŸ“ç»„ä»¶ | è¯´æ˜ |
|---------|--------|---------|------|
| post | text | TextCard | çº¯æ–‡æœ¬å¸–å­ |
| post | media | MediaCard | å›¾ç‰‡/è§†é¢‘å¸–å­ |
| post | audio | MediaCard | éŸ³é¢‘å¸–å­ |
| quest | novel | QuestCard | Questå­¦ä¹ å¡ç‰‡ |
| challenge | chapter | ChapterCard | ç« èŠ‚å­¦ä¹ å¡ç‰‡ |
| challenge | vocabulary | VocabularyCard | è¯æ±‡æŒ‘æˆ˜å¡ç‰‡ |

---

## ğŸ”§ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„å¸–å­ç±»å‹

**åœºæ™¯**ï¼šæ·»åŠ "æŠ•ç¥¨"ç±»å‹çš„å¸–å­

1. **å®šä¹‰ç±»å‹**
```typescript
// src/types/content.ts
export type PostSubType = 
  | 'text'
  | 'media'
  | 'audio'
  | 'poll'  // æ–°å¢
  | 'quote'
  | 'repost';
```

2. **æ·»åŠ åˆ†å‘è§„åˆ™**
```typescript
// src/lib/content/dispatcher.ts
{
  id: 'post-poll-detection',
  name: 'æŠ•ç¥¨æ£€æµ‹',
  priority: 95,
  condition: (data) => {
    return !!(data.metadata?.poll || data.metadata?.options);
  },
  action: (data) => ({
    suggestedType: 'poll',
    confidence: 0.97,
    reasons: ['åŒ…å«æŠ•ç¥¨é€‰é¡¹'],
    metadata: {
      optionsCount: data.metadata?.options?.length || 0
    }
  })
}
```

3. **åˆ›å»ºæ¸²æŸ“ç»„ä»¶**
```typescript
// src/components/feed/post-card/poll-card.tsx
export function PollCard({ card }: { card: FeedCard }) {
  // æŠ•ç¥¨å¡ç‰‡UI
  return <div>...</div>;
}
```

4. **æ›´æ–°è·¯ç”±**
```typescript
// src/components/feed/post-card/index.tsx
case 'poll':
  return <PollCard card={card} {...commonProps} />;
```

### æ·»åŠ æ–°çš„æŒ‘æˆ˜ç±»å‹

**åœºæ™¯**ï¼šæ·»åŠ "å£è¯­ç»ƒä¹ "æŒ‘æˆ˜

1. **å®šä¹‰ç±»å‹**
```typescript
export type ChallengeSubType = 
  | 'novel'
  | 'chapter'
  | 'vocabulary'
  | 'grammar'
  | 'listening'
  | 'speaking';  // æ–°å¢
```

2. **æ·»åŠ åˆ†å‘è§„åˆ™**
```typescript
{
  id: 'challenge-speaking-detection',
  name: 'å£è¯­æŒ‘æˆ˜æ£€æµ‹',
  priority: 85,
  condition: (data) => {
    return !!(data.metadata?.isSpeaking || 
              data.metadata?.pronunciation);
  },
  action: (data) => ({
    suggestedType: 'speaking',
    confidence: 0.93,
    reasons: ['åŒ…å«å£è¯­ç»ƒä¹ æ•°æ®']
  })
}
```

3. **åˆ›å»ºæ¸²æŸ“ç»„ä»¶**
```typescript
export function SpeakingCard({ card }: { card: FeedCard }) {
  // å£è¯­ç»ƒä¹ å¡ç‰‡UI
  return <div>...</div>;
}
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```typescript
// æµ‹è¯•æ™ºèƒ½åˆ†å‘å™¨
describe('ContentDispatcher', () => {
  it('should detect media posts', () => {
    const result = contentDispatcher.analyze({
      category: 'post',
      text: 'Check this out!',
      media: [{ type: 'image', url: '...' }]
    });
    
    expect(result.suggestedType).toBe('media');
    expect(result.confidence).toBeGreaterThan(0.9);
  });
  
  it('should detect novel challenges', () => {
    const result = contentDispatcher.analyze({
      category: 'challenge',
      text: 'Harry Potter Chapter 1',
      metadata: { novelId: 'hp-1' }
    });
    
    expect(result.suggestedType).toBe('novel');
  });
});
```

### é›†æˆæµ‹è¯•

```typescript
// æµ‹è¯•å®Œæ•´åˆ›å»ºæµç¨‹
describe('Content Creation Flow', () => {
  it('should create post and show in feed', async () => {
    // 1. åˆ›å»ºå¸–å­
    const response = await createPost({
      text: 'Test post',
      media: []
    });
    
    // 2. éªŒè¯å“åº”
    expect(response.id).toBeDefined();
    expect(response.category).toBe('post');
    
    // 3. éªŒè¯Feedæ›´æ–°
    const feed = await fetchFeed();
    expect(feed.cards[0].id).toBe(response.id);
  });
});
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. åˆ†å‘å™¨æ€§èƒ½
- è§„åˆ™æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œé«˜ä¼˜å…ˆçº§å…ˆæ‰§è¡Œ
- åŒ¹é…æˆåŠŸç«‹å³è¿”å›ï¼Œé¿å…ä¸å¿…è¦çš„è®¡ç®—
- è§„åˆ™æ¡ä»¶å‡½æ•°åº”è¯¥ç®€å•é«˜æ•ˆ

### 2. æ¸²æŸ“æ€§èƒ½
- ä½¿ç”¨React.memoä¼˜åŒ–ç»„ä»¶
- è™šæ‹Ÿæ»šåŠ¨å¤„ç†å¤§é‡å¡ç‰‡
- å›¾ç‰‡æ‡’åŠ è½½

### 3. APIæ€§èƒ½
- React Queryæ™ºèƒ½ç¼“å­˜
- ä¹è§‚æ›´æ–°æå‡ä½“éªŒ
- æ‰¹é‡æ“ä½œå‡å°‘è¯·æ±‚

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. è¾“å…¥éªŒè¯
```typescript
// å‰ç«¯éªŒè¯
- æ–‡æœ¬é•¿åº¦é™åˆ¶
- åª’ä½“ç±»å‹æ£€æŸ¥
- å…ƒæ•°æ®æ ¼å¼éªŒè¯

// åç«¯éªŒè¯
- Zod schemaéªŒè¯
- SQLæ³¨å…¥é˜²æŠ¤
- XSSé˜²æŠ¤
```

### 2. æƒé™æ§åˆ¶
```typescript
// Supabase RLSç­–ç•¥
CREATE POLICY "Users can create own content"
  ON feed_cards FOR INSERT
  WITH CHECK (auth.uid() = author_id);
```

---

## ğŸ“š æœ€ä½³å®è·µ

### 1. ç±»å‹å®‰å…¨
- ä½¿ç”¨TypeScriptä¸¥æ ¼æ¨¡å¼
- å®šä¹‰å®Œæ•´çš„ç±»å‹æ¥å£
- ä½¿ç”¨ç±»å‹å®ˆå«

### 2. ä»£ç ç»„ç»‡
- æŒ‰åŠŸèƒ½æ¨¡å—åˆ’åˆ†
- å•ä¸€èŒè´£åŸåˆ™
- ä¾èµ–æ³¨å…¥

### 3. é”™è¯¯å¤„ç†
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- å‹å¥½çš„é”™è¯¯æç¤º
- è¯¦ç»†çš„æ—¥å¿—è®°å½•

### 4. æ–‡æ¡£ç»´æŠ¤
- ä»£ç æ³¨é‡Šæ¸…æ™°
- APIæ–‡æ¡£å®Œæ•´
- æ¶æ„å›¾æ›´æ–°

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿
1. **ç®€åŒ–äº¤äº’**ï¼šä¸¤ä¸ªå…¥å£é™ä½ç”¨æˆ·è®¤çŸ¥è´Ÿæ‹…
2. **æ™ºèƒ½åˆ†å‘**ï¼šè‡ªåŠ¨è¯†åˆ«å†…å®¹ç±»å‹ï¼Œæå‡ä½“éªŒ
3. **ç»Ÿä¸€æ¶æ„**ï¼šå‰åç«¯ä¸€è‡´çš„æ•°æ®ç»“æ„
4. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢ç±»å‹åªéœ€æ·»åŠ è§„åˆ™

### æŠ€æœ¯äº®ç‚¹
- âœ… è§„åˆ™å¼•æ“é©±åŠ¨çš„æ™ºèƒ½åˆ†å‘
- âœ… å·¥å‚æ¨¡å¼çš„å¡ç‰‡æ¸²æŸ“
- âœ… å®Œæ•´çš„TypeScriptç±»å‹ç³»ç»Ÿ
- âœ… Mockå’ŒSupabaseåŒæ¨¡å¼æ”¯æŒ

### æœªæ¥å±•å¼€
- [ ] AIé©±åŠ¨çš„å†…å®¹åˆ†æ
- [ ] æ›´å¤šå†…å®¹ç±»å‹æ”¯æŒ
- [ ] ä¸ªæ€§åŒ–æ¨èç®—æ³•
- [ ] å¤šè¯­è¨€å†…å®¹æ”¯æŒ

---

**è®¾è®¡å®Œæˆæ—¶é—´**: 2025-01-25  
**æ¶æ„ç‰ˆæœ¬**: v2.0  
**ç»´æŠ¤è€…**: LinguaFlow Team
