# 📝 内容创建架构设计

## 🎯 设计理念

### 核心原则
1. **简化入口**：只有两个核心入口 - 新增帖子和新增挑战
2. **智能分发**：通过规则引擎自动识别内容类型
3. **统一接口**：前端和后端使用统一的数据结构
4. **易于扩展**：新增内容类型只需添加分发规则

### 设计优势
- ✅ **用户体验**：简洁直观，降低认知负担
- ✅ **开发效率**：统一的代码结构，易于维护
- ✅ **可扩展性**：新增类型无需修改核心逻辑
- ✅ **类型安全**：完整的 TypeScript 类型定义

---

## 🏗️ 架构设计

### 整体流程

```
用户点击FAB
    ↓
选择类别（帖子/挑战）
    ↓
打开统一创建模态框
    ↓
输入内容（文本+媒体+元数据）
    ↓
提交 → 智能分发器分析
    ↓
确定具体类型（text/media/novel等）
    ↓
调用API创建内容
    ↓
返回标准化响应
    ↓
Feed列表自动刷新
```

### 三层架构

```
┌─────────────────────────────────────────┐
│           UI Layer (表现层)              │
│  ┌──────────────┐  ┌──────────────────┐ │
│  │ UnifiedFAB   │  │UnifiedCreateModal│ │
│  │ (两个入口)    │  │  (动态表单)       │ │
│  └──────────────┘  └──────────────────┘ │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│        Business Logic Layer (业务层)     │
│  ┌──────────────────────────────────┐   │
│  │    ContentDispatcher             │   │
│  │    (智能分发器)                   │   │
│  │  - 规则匹配                       │   │
│  │  - 类型识别                       │   │
│  │  - 元数据提取                     │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         Data Layer (数据层)              │
│  ┌──────────────┐  ┌──────────────────┐ │
│  │ Content API  │  │  Feed API        │ │
│  │ (统一接口)    │  │  (兼容层)         │ │
│  └──────────────┘  └──────────────────┘ │
│         ↓                    ↓           │
│  ┌──────────────┐  ┌──────────────────┐ │
│  │ Mock Storage │  │  Supabase        │ │
│  └──────────────┘  └──────────────────┘ │
└─────────────────────────────────────────┘
```

---

## 📦 核心组件

### 1. UnifiedFAB (统一浮动按钮)

**职责**：
- 提供两个核心入口
- 优雅的动画交互
- 清晰的视觉层级

**特点**：
```typescript
<UnifiedFAB
  onCreatePost={() => {}}      // 新增帖子
  onCreateChallenge={() => {}} // 新增挑战
/>
```

**设计亮点**：
- 卡片式展开菜单
- 每个选项有图标+标题+描述
- 流畅的动画效果

### 2. UnifiedCreateModal (统一创建模态框)

**职责**：
- 根据类别动态调整UI
- 收集用户输入
- 提供高级选项

**特点**：
```typescript
<UnifiedCreateModal
  isOpen={true}
  category="post"  // 或 "challenge"
  onClose={() => {}}
  onSubmit={async (data) => {}}
/>
```

**动态UI**：
- **帖子模式**：简洁表单，280字限制
- **挑战模式**：扩展表单，难度选择，预计时长

### 3. ContentDispatcher (智能分发器)

**职责**：
- 分析内容特征
- 匹配分发规则
- 返回建议类型

**规则引擎**：
```typescript
// 示例规则
{
  id: 'post-media-detection',
  priority: 100,
  condition: (data) => data.media?.length > 0,
  action: (data) => ({
    suggestedType: 'media',
    confidence: 0.95,
    reasons: ['包含媒体内容']
  })
}
```

**分发逻辑**：
1. 按优先级排序规则
2. 依次执行条件判断
3. 返回第一个匹配的结果
4. 无匹配则使用默认类型

---

## 🔄 数据流

### 创建帖子流程

```typescript
// 1. 用户输入
{
  text: "Hello World!",
  media: [{ type: 'image', url: '...' }],
  metadata: {}
}

// 2. 智能分析
ContentDispatcher.analyze({
  category: 'post',
  text: "Hello World!",
  media: [...]
})

// 3. 分析结果
{
  category: 'post',
  suggestedType: 'media',  // 因为包含图片
  confidence: 0.95,
  reasons: ['包含图片内容'],
  metadata: {
    mediaCount: 1,
    mediaTypes: ['image']
  }
}

// 4. API调用
createPost({
  text: "Hello World!",
  media: [...]
})

// 5. 返回响应
{
  id: 'post-123',
  category: 'post',
  type: 'media',
  content: { ... },
  author: { ... },
  createdAt: '2025-01-25T...',
  analysis: { ... }
}
```

### 创建挑战流程

```typescript
// 1. 用户输入
{
  text: "Learn Harry Potter Chapter 1",
  media: [],
  metadata: {
    difficulty: 3,
    estimatedTime: '30分钟',
    tags: ['Fantasy', 'British English']
  }
}

// 2. 智能分析
ContentDispatcher.analyze({
  category: 'challenge',
  text: "...",
  metadata: { ... }
})

// 3. 分析结果
{
  category: 'challenge',
  suggestedType: 'novel',  // 识别为小说挑战
  confidence: 0.98,
  reasons: ['包含小说相关关键词'],
  metadata: {
    difficulty: 3,
    estimatedTime: '30分钟'
  }
}

// 4. API调用
createChallenge({
  text: "...",
  challengeType: 'novel',
  difficulty: 3,
  ...
})

// 5. 返回响应 + 自动转换为FeedCard
```

---

## 🎨 卡片渲染

### 渲染策略

```typescript
// PostCard工厂模式
function PostCard({ card }) {
  switch (card.type) {
    case 'text':
      return <TextCard card={card} />;
    case 'media':
      return <MediaCard card={card} />;
    case 'audio':
      return <MediaCard card={card} />;
    case 'novel':
      return <QuestCard card={card} />;
    case 'chapter':
      return <ChapterCard card={card} />;
    default:
      return <TextCard card={card} />;
  }
}
```

### 类型映射

| 内容类别 | 子类型 | 渲染组件 | 说明 |
|---------|--------|---------|------|
| post | text | TextCard | 纯文本帖子 |
| post | media | MediaCard | 图片/视频帖子 |
| post | audio | MediaCard | 音频帖子 |
| quest | novel | QuestCard | Quest学习卡片 |
| challenge | chapter | ChapterCard | 章节学习卡片 |
| challenge | vocabulary | VocabularyCard | 词汇挑战卡片 |

---

## 🔧 扩展指南

### 添加新的帖子类型

**场景**：添加"投票"类型的帖子

1. **定义类型**
```typescript
// src/types/content.ts
export type PostSubType = 
  | 'text'
  | 'media'
  | 'audio'
  | 'poll'  // 新增
  | 'quote'
  | 'repost';
```

2. **添加分发规则**
```typescript
// src/lib/content/dispatcher.ts
{
  id: 'post-poll-detection',
  name: '投票检测',
  priority: 95,
  condition: (data) => {
    return !!(data.metadata?.poll || data.metadata?.options);
  },
  action: (data) => ({
    suggestedType: 'poll',
    confidence: 0.97,
    reasons: ['包含投票选项'],
    metadata: {
      optionsCount: data.metadata?.options?.length || 0
    }
  })
}
```

3. **创建渲染组件**
```typescript
// src/components/feed/post-card/poll-card.tsx
export function PollCard({ card }: { card: FeedCard }) {
  // 投票卡片UI
  return <div>...</div>;
}
```

4. **更新路由**
```typescript
// src/components/feed/post-card/index.tsx
case 'poll':
  return <PollCard card={card} {...commonProps} />;
```

### 添加新的挑战类型

**场景**：添加"口语练习"挑战

1. **定义类型**
```typescript
export type ChallengeSubType = 
  | 'novel'
  | 'chapter'
  | 'vocabulary'
  | 'grammar'
  | 'listening'
  | 'speaking';  // 新增
```

2. **添加分发规则**
```typescript
{
  id: 'challenge-speaking-detection',
  name: '口语挑战检测',
  priority: 85,
  condition: (data) => {
    return !!(data.metadata?.isSpeaking || 
              data.metadata?.pronunciation);
  },
  action: (data) => ({
    suggestedType: 'speaking',
    confidence: 0.93,
    reasons: ['包含口语练习数据']
  })
}
```

3. **创建渲染组件**
```typescript
export function SpeakingCard({ card }: { card: FeedCard }) {
  // 口语练习卡片UI
  return <div>...</div>;
}
```

---

## 🧪 测试策略

### 单元测试

```typescript
// 测试智能分发器
describe('ContentDispatcher', () => {
  it('should detect media posts', () => {
    const result = contentDispatcher.analyze({
      category: 'post',
      text: 'Check this out!',
      media: [{ type: 'image', url: '...' }]
    });
    
    expect(result.suggestedType).toBe('media');
    expect(result.confidence).toBeGreaterThan(0.9);
  });
  
  it('should detect novel challenges', () => {
    const result = contentDispatcher.analyze({
      category: 'challenge',
      text: 'Harry Potter Chapter 1',
      metadata: { novelId: 'hp-1' }
    });
    
    expect(result.suggestedType).toBe('novel');
  });
});
```

### 集成测试

```typescript
// 测试完整创建流程
describe('Content Creation Flow', () => {
  it('should create post and show in feed', async () => {
    // 1. 创建帖子
    const response = await createPost({
      text: 'Test post',
      media: []
    });
    
    // 2. 验证响应
    expect(response.id).toBeDefined();
    expect(response.category).toBe('post');
    
    // 3. 验证Feed更新
    const feed = await fetchFeed();
    expect(feed.cards[0].id).toBe(response.id);
  });
});
```

---

## 📊 性能优化

### 1. 分发器性能
- 规则按优先级排序，高优先级先执行
- 匹配成功立即返回，避免不必要的计算
- 规则条件函数应该简单高效

### 2. 渲染性能
- 使用React.memo优化组件
- 虚拟滚动处理大量卡片
- 图片懒加载

### 3. API性能
- React Query智能缓存
- 乐观更新提升体验
- 批量操作减少请求

---

## 🔒 安全考虑

### 1. 输入验证
```typescript
// 前端验证
- 文本长度限制
- 媒体类型检查
- 元数据格式验证

// 后端验证
- Zod schema验证
- SQL注入防护
- XSS防护
```

### 2. 权限控制
```typescript
// Supabase RLS策略
CREATE POLICY "Users can create own content"
  ON feed_cards FOR INSERT
  WITH CHECK (auth.uid() = author_id);
```

---

## 📚 最佳实践

### 1. 类型安全
- 使用TypeScript严格模式
- 定义完整的类型接口
- 使用类型守卫

### 2. 代码组织
- 按功能模块划分
- 单一职责原则
- 依赖注入

### 3. 错误处理
- 统一的错误处理
- 友好的错误提示
- 详细的日志记录

### 4. 文档维护
- 代码注释清晰
- API文档完整
- 架构图更新

---

## 🎯 总结

### 核心优势
1. **简化交互**：两个入口降低用户认知负担
2. **智能分发**：自动识别内容类型，提升体验
3. **统一架构**：前后端一致的数据结构
4. **易于扩展**：新增类型只需添加规则

### 技术亮点
- ✅ 规则引擎驱动的智能分发
- ✅ 工厂模式的卡片渲染
- ✅ 完整的TypeScript类型系统
- ✅ Mock和Supabase双模式支持

### 未来展开
- [ ] AI驱动的内容分析
- [ ] 更多内容类型支持
- [ ] 个性化推荐算法
- [ ] 多语言内容支持

---

**设计完成时间**: 2025-01-25  
**架构版本**: v2.0  
**维护者**: LinguaFlow Team
