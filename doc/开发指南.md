# 🛠️ LinguaFlow 开发指南

## 📋 开发环境配置

### 环境要求
- Node.js >= 20
- pnpm >= 9
- Git

### 快速启动
```bash
# 1. 克隆项目
git clone <repository-url>
cd linguaflow

# 2. 安装依赖
pnpm install

# 3. 启动开发服务器
pnpm dev

# 4. 访问应用
# 打开浏览器访问 http://localhost:3000
```

---

## 🏗️ 项目结构

```
linguaflow/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (main)/            # 主应用布局
│   │   │   ├── feed/          # Feed 流页面
│   │   │   ├── post/[id]/     # 帖子详情页
│   │   │   └── page.tsx       # 首页
│   │   ├── layout.tsx         # 根布局
│   │   └── globals.css        # 全局样式
│   │
│   ├── components/            # React 组件
│   │   ├── feed/              # Feed 相关组件
│   │   │   ├── cards/         # 卡片组件
│   │   │   ├── feed-header.tsx
│   │   │   ├── feed-list.tsx
│   │   │   └── post-card/     # 帖子卡片组件
│   │   │       ├── index.tsx
│   │   │       ├── novel-card.tsx
│   │   │       ├── text-card.tsx
│   │   │       ├── media-card.tsx
│   │   │       ├── post-author.tsx
│   │   │       ├── post-content.tsx
│   │   │       └── post-actions.tsx
│   │   ├── providers/         # Context Providers
│   │   │   ├── theme-provider.tsx
│   │   │   └── query-provider.tsx
│   │   └── ui/                # UI 组件库
│   │       ├── badge.tsx
│   │       ├── button.tsx
│   │       └── card.tsx
│   │
│   ├── hooks/                 # 自定义 Hooks
│   │   ├── use-like.ts
│   │   └── use-realtime.ts
│   │
│   ├── lib/                   # 工具库
│   │   ├── api/               # API 层
│   │   │   └── feed.ts
│   │   ├── challenges/        # 挑战系统
│   │   │   ├── plugin-system.ts
│   │   │   └── plugins/
│   │   │       └── vocabulary-plugin.tsx
│   │   ├── storage/           # 存储系统
│   │   │   └── hyper-storage.ts
│   │   ├── supabase/          # Supabase 客户端
│   │   │   ├── client.ts
│   │   │   └── server.ts
│   │   ├── sync/              # 数据同步
│   │   │   ├── data-sync.ts
│   │   │   └── schema-version.ts
│   │   └── utils.ts
│   │
│   ├── types/                 # TypeScript 类型
│   │   ├── feed.ts
│   │   ├── learn.ts
│   │   └── supabase.ts
│   │
│   └── config/                # 配置文件
│       └── constants.ts
│
├── supabase/                  # Supabase 配置
│   └── migrations/            # 数据库迁移
│       └── 20250124000001_initial_schema.sql
│
├── public/                    # 静态资源
│   └── manifest.json
│
├── doc/                       # 文档
│   ├── README.md
│   ├── 快速开始.md
│   ├── 项目概述.md
│   ├── 架构设计.md
│   ├── 部署指南.md
│   ├── 功能测试.md
│   ├── 项目使用文档.md
│   └── 开发指南.md
│
├── scripts/                   # 脚本
│   └── check-data-sync.ts
│
├── package.json
├── pnpm-lock.yaml
├── pnpm-workspace.yaml
├── next.config.ts
├── postcss.config.mjs
├── tailwind.config.ts
├── tsconfig.json
└── start.sh
```

---

## 🎨 核心功能详解

### 1. Feed 流系统

#### 主要组件
- **`FeedListSimple`**: 简化的 Feed 列表组件，用于调试
- **`PostCard`**: 帖子卡片工厂组件，根据类型路由到不同卡片
- **`QuestCard`**: Quest学习卡片
- **`TextCard`**: 文本帖子卡片
- **`MediaCard`**: 媒体帖子卡片

#### 卡片类型
```typescript
export type FeedCardType = 
  | 'novel'     // 小说学习卡片
  | 'text'      // 文本帖子
  | 'media'     // 媒体帖子
  | 'audio'     // 音频帖子
  | 'ad'        // 广告卡片
  | 'quote'     // 引用帖子
  | 'repost';   // 转发帖子
```

#### 使用示例
```tsx
import { FeedListSimple } from '@/components/feed/feed-list-simple';

function HomePage() {
  return (
    <div>
      <FeedListSimple 
        filters={{ type: 'novel' }}
        onCardInteraction={(cardId, action) => {
          console.log(`Card ${cardId} action: ${action}`);
        }}
      />
    </div>
  );
}
```

### 2. 状态管理

#### Zustand Store 结构
```typescript
// 用户状态
interface UserStore {
  user: User | null;
  setUser: (user: User) => void;
  logout: () => void;
}

// UI 状态
interface UIStore {
  theme: 'light' | 'dark';
  bottomNavVisible: boolean;
  setTheme: (theme) => void;
}
```

#### React Query 配置
```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 60 * 1000, // 1分钟
      gcTime: 5 * 60 * 1000, // 5分钟
      refetchOnWindowFocus: false,
      retry: 1,
    },
  },
});
```

### 3. 数据获取

#### Feed API
```typescript
// 获取 Feed 数据
const { data, fetchNextPage } = useInfiniteQuery({
  queryKey: ['feed'],
  queryFn: fetchFeed,
  getNextPageParam: (lastPage) => lastPage.nextCursor,
});

// 实时订阅
useEffect(() => {
  const channel = supabase
    .channel('feed-changes')
    .on('postgres_changes', { ... }, handler)
    .subscribe();
  
  return () => supabase.removeChannel(channel);
}, []);
```

#### Mock 数据
项目包含完整的 Mock 数据，包括：
- 4 个示例卡片（小说、文本、媒体）
- 用户信息
- 统计数据
- 交互状态

### 4. 组件设计

#### PostCard 工厂模式
```typescript
const PostCard = memo(function PostCard({ card, onInteraction }: PostCardProps) {
  // 根据卡片类型渲染不同组件
  switch (card.type) {
    case 'novel':
      return <QuestCard card={card} {...commonProps} />;
    case 'media':
      return <MediaCard card={card} {...commonProps} />;
    default:
      return <TextCard card={card} {...commonProps} />;
  }
});
```

#### 交互处理
```typescript
// 点赞处理
const handleLike = useCallback(async () => {
  try {
    const action = card.viewer?.liked ? 'unlike' : 'like';
    await interactWithPost(card.id, action);
    onInteraction?.(card.id, action);
  } catch (error) {
    console.error('Failed to like:', error);
  }
}, [card.id, card.viewer?.liked, onInteraction]);
```

---

## 🎨 UI/UX 设计

### 1. 设计系统

#### 颜色系统
```css
:root {
  --color-primary: #3b82f6;
  --color-secondary: #f1f5f9;
  --color-muted: #f8fafc;
  --color-background: #ffffff;
  --color-foreground: #0f172a;
}
```

#### 组件样式
- **毛玻璃效果**: `glass-effect` 类
- **流畅动画**: Framer Motion 驱动
- **响应式设计**: 完美适配所有设备
- **深色模式**: 自动切换

### 2. 卡片设计

#### QuestCard 特色
- 封面图片展示
- 难度等级标识
- 学习进度显示
- 标签系统
- 开始学习按钮

#### 交互设计
- 悬停效果
- 点击反馈
- 加载状态
- 错误处理

---

## 🔧 配置说明

### 1. 环境变量
```bash
# 开发环境（默认使用 Mock 数据）
NEXT_PUBLIC_ENABLE_BACKEND_SYNC=false

# 生产环境（使用 Supabase）
NEXT_PUBLIC_ENABLE_BACKEND_SYNC=true
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 2. Tailwind CSS 配置
```javascript
// postcss.config.mjs
export default {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};
```

### 3. Next.js 配置
```typescript
// next.config.ts
const nextConfig: NextConfig = {
  reactStrictMode: true,
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**.supabase.co',
      },
    ],
  },
  experimental: {
    optimizePackageImports: ['lucide-react', 'framer-motion'],
  },
};
```

---

## 📊 数据库设计

### 核心表结构
```sql
-- 用户资料表
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  level INTEGER DEFAULT 1,
  experience INTEGER DEFAULT 0,
  streak_days INTEGER DEFAULT 0
);

-- Feed 卡片表
CREATE TABLE public.feed_cards (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  type VARCHAR(20) NOT NULL,
  author_id UUID REFERENCES public.profiles(id),
  content JSONB NOT NULL,
  likes_count INTEGER DEFAULT 0,
  comments_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 用户进度表
CREATE TABLE public.user_progress (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES public.profiles(id),
  chapter_id UUID REFERENCES public.novel_chapters(id),
  status VARCHAR(20) DEFAULT 'not_started',
  best_score INTEGER DEFAULT 0,
  attempts INTEGER DEFAULT 0
);
```

### RLS 策略
```sql
-- 用户只能修改自己的数据
CREATE POLICY "Users can update own profile"
  ON public.profiles FOR UPDATE
  USING (auth.uid() = id);

-- 公开内容所有人可见
CREATE POLICY "Public cards are viewable"
  ON public.feed_cards FOR SELECT
  USING (visibility = 'public');
```

---

## 🚀 性能优化

### 1. 前端优化
- **虚拟滚动**: 处理海量数据
- **图片优化**: Next.js Image 自动优化
- **代码分割**: 按需加载组件
- **智能缓存**: React Query + IndexedDB

### 2. 后端优化
- **数据库索引**: 优化查询性能
- **缓存策略**: 2分钟 stale, 5分钟 cache
- **实时订阅**: Supabase Realtime 优化

### 3. 构建优化
- **代码分割**: 首屏加载 102 kB
- **图片优化**: 自动格式转换
- **Tree Shaking**: 移除未使用代码

---

## 🔒 安全设计

### 1. 认证和授权
- **Supabase Auth**: 用户认证
- **RLS 策略**: 行级安全
- **JWT Token**: 安全令牌

### 2. 数据验证
- **Zod 验证**: 类型安全
- **API 验证**: 输入验证
- **XSS 防护**: 内容清理

### 3. 隐私保护
- **数据加密**: 敏感数据加密
- **访问控制**: 基于角色的权限
- **审计日志**: 操作记录

---

## 📱 移动端优化

### 1. PWA 支持
- **Manifest**: 应用清单
- **Service Worker**: 离线支持
- **安装提示**: 原生应用体验

### 2. 响应式设计
- **断点系统**: 移动优先
- **触摸优化**: 手势支持
- **性能优化**: 60fps 动画

### 3. 用户体验
- **下拉刷新**: 原生交互
- **无限滚动**: 流畅浏览
- **离线支持**: 无网络访问

---

## 🧪 测试策略

### 1. 单元测试
```typescript
// 组件测试示例
import { render, screen } from '@testing-library/react';
import { PostCard } from '@/components/feed/post-card';

test('renders post card', () => {
  render(<PostCard card={mockCard} />);
  expect(screen.getByText(mockCard.content)).toBeInTheDocument();
});
```

### 2. 集成测试
- **API 测试**: 数据获取
- **用户交互**: 点击、输入
- **状态管理**: 状态更新

### 3. E2E 测试
- **用户流程**: 完整操作
- **性能测试**: 加载时间
- **兼容性**: 多浏览器

---

## 🚀 部署指南

### 1. 开发环境
```bash
# 本地开发
pnpm dev

# 类型检查
pnpm type-check

# 代码检查
pnpm lint
```

### 2. 生产环境
```bash
# 构建应用
pnpm build

# 启动生产服务器
pnpm start
```

### 3. 部署平台
- **Vercel**: 推荐平台
- **Netlify**: 备选方案
- **Docker**: 容器化部署

---

## 🔧 开发工具

### 1. 代码质量
- **ESLint**: 代码检查
- **Prettier**: 代码格式化
- **TypeScript**: 类型检查

### 2. 调试工具
- **React DevTools**: 组件调试
- **Redux DevTools**: 状态调试
- **Network Tab**: 网络调试

### 3. 性能监控
- **Lighthouse**: 性能审计
- **Bundle Analyzer**: 包大小分析
- **Core Web Vitals**: 核心指标

---

## 📚 学习资源

### 1. 技术文档
- [Next.js 文档](https://nextjs.org/docs)
- [React 文档](https://react.dev/)
- [Tailwind CSS 文档](https://tailwindcss.com/docs)
- [Supabase 文档](https://supabase.com/docs)

### 2. 最佳实践
- [React 最佳实践](https://react.dev/learn)
- [TypeScript 指南](https://www.typescriptlang.org/docs/)
- [性能优化指南](https://web.dev/performance/)

### 3. 社区资源
- [GitHub Issues](https://github.com/your-repo/issues)
- [Discord 社区](https://discord.gg/your-community)
- [Stack Overflow](https://stackoverflow.com/questions/tagged/linguaflow)

---

## 🤝 贡献指南

### 1. 开发流程
1. Fork 项目
2. 创建功能分支
3. 提交代码
4. 创建 Pull Request

### 2. 代码规范
- 遵循 ESLint 规则
- 使用 TypeScript
- 编写测试用例
- 更新文档

### 3. 提交规范
```
feat: 新功能
fix: 修复问题
docs: 文档更新
style: 代码格式
refactor: 重构
test: 测试
chore: 构建
```

---

## 📞 支持与反馈

### 1. 问题报告
- [GitHub Issues](https://github.com/your-repo/issues)
- 邮件支持: support@linguaflow.com
- 社区论坛: [Discord](https://discord.gg/your-community)

### 2. 功能请求
- 使用 GitHub Issues
- 详细描述需求
- 提供使用场景

### 3. 贡献代码
- 查看 [CONTRIBUTING.md](./CONTRIBUTING.md)
- 遵循代码规范
- 编写测试用例

---

## 📄 许可证

MIT License - 详见 [LICENSE](./LICENSE) 文件

---

## 🙏 致谢

本项目参考了以下优秀开源项目：
- [Supabase](https://github.com/supabase/supabase) - BaaS 架构
- [Lobe Chat](https://github.com/lobehub/lobe-chat) - 插件系统和状态管理
- [X (Twitter)](https://twitter.com) - UI/UX 设计
- [Apple](https://apple.com) - 设计语言

---

**Made with ❤️ by LinguaFlow Team**

*基于 Supabase 和 Lobe Chat 最佳实践打造*
