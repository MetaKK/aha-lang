# 🔧 环境配置说明

## 必需环境变量

### Supabase 配置
```bash
# Supabase 项目URL
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co

# Supabase 匿名密钥
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# 启用后端同步
NEXT_PUBLIC_ENABLE_BACKEND_SYNC=true
```

### 开发环境配置
```bash
# 环境模式
NODE_ENV=development

# 端口配置（可选）
PORT=3000
```

## 获取 Supabase 配置

### 1. 创建 Supabase 项目
1. 访问 [Supabase Dashboard](https://supabase.com/dashboard)
2. 点击 "New Project"
3. 填写项目信息
4. 等待项目创建完成

### 2. 获取项目配置
1. 进入项目 Dashboard
2. 点击 "Settings" → "API"
3. 复制以下信息：
   - **Project URL**: `https://your-project.supabase.co`
   - **anon public**: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`

### 3. 配置数据库
1. 进入 "SQL Editor"
2. 运行以下迁移：
   ```sql
   -- 运行初始schema
   \i supabase/migrations/20250124000001_initial_schema.sql
   
   -- 运行认证集成
   \i supabase/migrations/20250124000002_auth_integration.sql
   ```

### 4. 配置认证
1. 进入 "Authentication" → "Settings"
2. 启用以下选项：
   - ✅ Email/Password
   - ✅ Email confirmations
   - ✅ Email change confirmations
3. 配置重定向URL：
   ```
   http://localhost:3000/auth/callback
   https://yourdomain.com/auth/callback
   ```

## 本地开发配置

### 1. 创建环境变量文件
```bash
# 复制配置模板
cp .env.example .env.local

# 编辑配置文件
nano .env.local
```

### 2. 配置内容
```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
NEXT_PUBLIC_ENABLE_BACKEND_SYNC=true
NODE_ENV=development
```

### 3. 启动开发服务器
```bash
# 安装依赖
pnpm install

# 启动开发服务器
pnpm dev
```

## 生产环境配置

### 1. Vercel 部署配置
在 Vercel Dashboard 中设置环境变量：

```bash
# 生产环境变量
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
NEXT_PUBLIC_ENABLE_BACKEND_SYNC=true
NODE_ENV=production
```

### 2. 域名配置
在 Supabase Dashboard 中配置：
```
Authentication → Settings → Site URL
https://yourdomain.com

Authentication → Settings → Redirect URLs
https://yourdomain.com/auth/callback
```

## 测试配置

### 1. 运行认证测试
```bash
# 安装测试依赖
pnpm add -D tsx

# 运行认证测试
npx tsx scripts/test-auth.ts
```

### 2. 手动测试流程
1. 访问 `http://localhost:3000`
2. 自动重定向到 `/auth`
3. 注册新用户
4. 验证邮箱（开发环境可能跳过）
5. 登录用户
6. 测试发帖功能

## 故障排除

### 1. 连接 Supabase 失败
**检查**：
- ✅ 环境变量是否正确设置
- ✅ Supabase 项目是否正常运行
- ✅ 网络连接是否正常

**解决**：
```bash
# 检查环境变量
echo $NEXT_PUBLIC_SUPABASE_URL
echo $NEXT_PUBLIC_SUPABASE_ANON_KEY

# 测试连接
curl -H "apikey: $NEXT_PUBLIC_SUPABASE_ANON_KEY" \
     $NEXT_PUBLIC_SUPABASE_URL/rest/v1/
```

### 2. 认证失败
**检查**：
- ✅ 邮箱验证是否完成
- ✅ 密码是否符合要求
- ✅ 用户是否已注册

**解决**：
```bash
# 检查 Supabase 日志
# Dashboard → Logs → Auth
```

### 3. 权限错误
**检查**：
- ✅ RLS 策略是否正确配置
- ✅ 用户是否有相应权限
- ✅ 数据库连接是否正常

**解决**：
```sql
-- 检查 RLS 策略
SELECT * FROM pg_policies WHERE tablename = 'profiles';

-- 临时禁用 RLS（仅测试）
ALTER TABLE public.profiles DISABLE ROW LEVEL SECURITY;
```

## 安全注意事项

### 1. 环境变量安全
- ❌ 不要将 `.env` 文件提交到版本控制
- ✅ 使用 `.env.example` 作为模板
- ✅ 生产环境使用安全的密钥管理

### 2. Supabase 安全
- ✅ 启用 RLS 策略
- ✅ 配置适当的 CORS 设置
- ✅ 定期轮换 API 密钥

### 3. 生产环境
- ✅ 使用 HTTPS
- ✅ 配置安全头
- ✅ 启用 CSP 策略

---

**配置状态**: ✅ 完成  
**测试状态**: ⏳ 待验证  
**部署状态**: ⏳ 待配置
