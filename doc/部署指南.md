# 🚀 LinguaFlow 部署快速指南

## 📋 技术架构

**前端**: Next.js 15 → **Vercel** (推荐) ✅  
**后端**: Supabase (PostgreSQL + Auth + Storage + Realtime) ✅

---

## 一、后端部署 - Supabase (5分钟)

### 1. 创建项目

1. 访问 https://supabase.com 并登录
2. 点击 **New Project**
3. 填写信息:
   - 项目名称: `linguaflow-prod`
   - 数据库密码: (生成并保存)
   - 区域: **Singapore** (中国用户最快)
   - 计划: **Free Plan** (开发) 或 **Pro Plan** ($25/月，生产)

### 2. 初始化数据库

在 Supabase Dashboard:
1. 左侧菜单 → **SQL Editor**
2. 点击 **New Query**
3. 复制 `supabase/migrations/20250124000001_initial_schema.sql` 文件内容
4. 粘贴并点击 **Run**

### 3. 获取 API 密钥

**Settings** → **API** → 复制:
```
Project URL: https://xxxxx.supabase.co
anon public key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

✅ 后端配置完成！

---

## 二、前端部署 - Vercel (3分钟)

### 1. 推送代码到 GitHub

```bash
git add .
git commit -m "Ready for deployment"
git push origin main
```

### 2. 导入项目到 Vercel

1. 访问 https://vercel.com 并登录
2. 点击 **Add New** → **Project**
3. 选择你的 GitHub 仓库
4. 点击 **Import**

### 3. 配置环境变量

在 Vercel 项目设置中:  
**Settings** → **Environment Variables** → 添加:

```bash
# 必需
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
NEXT_PUBLIC_ENABLE_BACKEND_SYNC=true

# 可选
NEXT_PUBLIC_APP_URL=https://yourdomain.com
```

### 4. 部署

点击 **Deploy** → 等待 2-3 分钟 ✅

访问: `https://your-project.vercel.app`

---

## 三、自定义域名（可选）

### 在 Vercel 配置

1. **Settings** → **Domains**
2. 输入域名: `linguaflow.com`
3. 按提示配置 DNS

### DNS 配置（推荐使用 Cloudflare）

```
类型: A
名称: @
内容: 76.76.21.21
```

等待 5-30 分钟生效。

---

## 四、Supabase 额外配置

### 启用实时订阅

**Database** → **Replication** → 勾选:
- ✅ `feed_cards`
- ✅ `interactions`
- ✅ `user_progress`

### 配置存储桶

**Storage** → 创建桶:
1. `avatars` (用户头像) - Public
2. `covers` (封面图) - Public
3. `media` (音视频) - Public

### 配置认证

**Authentication** → **Providers** → 启用:
- ✅ Email/Password
- ✅ Magic Link
- 可选: Google, GitHub 等

**URL Configuration** → 添加回调地址:
```
https://yourdomain.com/auth/callback
```

---

## 五、成本估算

### 免费方案（开发阶段）
- Vercel Hobby: **免费** (100GB 带宽)
- Supabase Free: **免费** (500MB 数据库, 1GB 存储)
- **总计: $0/月** ✅

### 生产方案（小规模）
- Vercel Pro: **$20/月** (1TB 带宽)
- Supabase Pro: **$25/月** (8GB 数据库, 100GB 存储)
- **总计: $45/月** (可支持数千用户)

---

## 六、部署检查清单

### Supabase 配置
- [ ] 项目已创建
- [ ] 数据库表已创建（运行 SQL）
- [ ] API 密钥已复制
- [ ] Realtime 已启用
- [ ] 存储桶已创建
- [ ] 认证已配置

### Vercel 配置
- [ ] 代码已推送到 GitHub
- [ ] 项目已导入 Vercel
- [ ] 环境变量已设置
- [ ] 部署成功
- [ ] 网站可访问

### 功能测试
- [ ] 页面正常加载
- [ ] Feed 流显示数据
- [ ] 图片正常加载
- [ ] 用户可以登录/注册
- [ ] 实时更新功能正常

---

## 七、常见问题

### 1. 连接 Supabase 失败

**检查**:
```bash
# 确认环境变量
- NEXT_PUBLIC_SUPABASE_URL 是否正确
- NEXT_PUBLIC_SUPABASE_ANON_KEY 是否正确
- NEXT_PUBLIC_ENABLE_BACKEND_SYNC=true
```

### 2. RLS 策略阻止访问

在 Supabase SQL Editor 执行:
```sql
-- 检查策略
SELECT * FROM pg_policies WHERE tablename = 'feed_cards';

-- 临时禁用（仅测试）
ALTER TABLE public.feed_cards DISABLE ROW LEVEL SECURITY;
```

### 3. Vercel 构建失败

```bash
# 清除缓存并重新部署
在 Vercel Dashboard → Deployments → Redeploy
```

### 4. 环境变量不生效

- 修改环境变量后必须 **重新部署**
- 在 Deployments → ... → Redeploy

---

## 八、本地开发配置

创建 `.env.local` 文件:

```bash
# 开发环境使用本地存储
NEXT_PUBLIC_ENABLE_BACKEND_SYNC=false
NEXT_PUBLIC_APP_URL=http://localhost:3000

# 如果要测试 Supabase
# NEXT_PUBLIC_ENABLE_BACKEND_SYNC=true
# NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
# NEXT_PUBLIC_SUPABASE_ANON_KEY=your-key
```

启动开发服务器:
```bash
pnpm dev
```

---

## 九、下一步优化

- [ ] 配置 Cloudflare CDN 加速
- [ ] 设置自动备份（Supabase）
- [ ] 添加监控告警（Sentry）
- [ ] 配置 CI/CD（GitHub Actions）
- [ ] 性能测试和优化
- [ ] 安全审计

---

## 📚 详细文档

查看完整的部署指南: [DEPLOYMENT_GUIDE.md](../DEPLOYMENT_GUIDE.md)

---

## 🔗 相关资源

- [Vercel 文档](https://vercel.com/docs)
- [Supabase 文档](https://supabase.com/docs)
- [Next.js 文档](https://nextjs.org/docs)

---

**祝部署顺利! 🎉**

有问题可以查看详细文档或在社区寻求帮助。

