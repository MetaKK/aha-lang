# 后端架构总结

## 🎯 架构目标

构建一个**标准化、可扩展、多端通用**的后端 API 系统，支持 Web、小程序、App 等多个前端应用。

## 📐 架构设计

### 三层架构

```
┌─────────────────────────────────────────┐
│         前端应用层 (Multiple Clients)      │
│  Web App  │  小程序  │  iOS  │  Android  │
└─────────────┬───────────────────────────┘
              │ HTTP/HTTPS
              │
┌─────────────▼───────────────────────────┐
│          API 路由层 (Routes)             │
│  /api/feed  │  /api/quests  │  /api/users│
│  ├─ 认证中间件                            │
│  ├─ CORS 中间件                           │
│  ├─ 日志中间件                            │
│  └─ 错误处理中间件                         │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│        业务逻辑层 (Services)              │
│  FeedService  │  QuestService  │  UserService│
│  ├─ 业务规则验证                          │
│  ├─ 权限检查                              │
│  └─ 数据转换                              │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│         数据访问层 (Database)             │
│         Supabase PostgreSQL              │
│  feed_cards  │  quests  │  profiles     │
└─────────────────────────────────────────┘
```

## 🗂️ 目录结构

```
src/
├── app/
│   └── api/                      # API 路由
│       ├── feed/
│       │   ├── route.ts         # GET /api/feed, POST /api/feed
│       │   └── [id]/
│       │       └── route.ts     # GET/PUT/DELETE /api/feed/:id
│       ├── interactions/
│       │   └── route.ts         # POST/DELETE /api/interactions
│       ├── quests/
│       │   ├── [id]/
│       │   │   └── route.ts     # GET /api/quests/:id
│       │   └── submit/
│       │       └── route.ts     # POST /api/quests/submit
│       └── users/
│           └── [id]/
│               └── route.ts     # GET/PUT /api/users/:id
│
├── lib/
│   └── api/
│       ├── types/               # 类型定义
│       │   ├── response.ts      # 统一响应格式
│       │   └── dto.ts           # 数据传输对象
│       │
│       ├── middleware/          # 中间件
│       │   ├── auth.middleware.ts    # 认证
│       │   ├── cors.middleware.ts    # CORS
│       │   ├── error.middleware.ts   # 错误处理
│       │   └── logger.middleware.ts  # 日志
│       │
│       └── services/            # 业务逻辑
│           ├── base.service.ts       # 基础 Service
│           ├── feed.service.ts       # Feed 业务
│           ├── quest.service.ts      # Quest 业务
│           ├── interaction.service.ts # 互动业务
│           └── user.service.ts       # 用户业务
│
├── types/                       # 前端类型
│   ├── feed.ts                  # Feed 卡片类型
│   ├── content.ts               # 内容创建类型
│   └── supabase.ts              # 数据库类型
│
└── supabase/
    └── migrations/              # 数据库迁移
        └── 20250124000001_complete_schema.sql
```

## 🔄 数据流转

### 1. 前端 → 后端 → 数据库

```typescript
// 前端创建内容
const contentData: ContentCreationData = {
  category: 'quest',
  text: '学习英语',
  questType: 'novel',
  difficulty: 3,
  tags: ['英语', '学习']
};

// ↓ 转换为 API 请求
const apiRequest: CreateFeedCardRequest = {
  type: 'novel',
  content: { text: '学习英语' },
  metadata: { category: 'quest', novel: { ... } },
  difficulty: 3,
  tags: ['英语', '学习']
};

// ↓ Service 层处理
const cardData = {
  authorId: userId,
  type: 'novel',
  content: { text: '学习英语' },
  metadata: { ... },
  difficulty: 3,
  tags: ['英语', '学习']
};

// ↓ 转换为数据库字段 (camelCase → snake_case)
const dbData = {
  author_id: userId,
  type: 'novel',
  content: { text: '学习英语' },
  metadata: { ... },
  difficulty: 3,
  tags: ['英语', '学习']
};

// ↓ 插入数据库
INSERT INTO feed_cards (author_id, type, content, ...) VALUES (...);
```

### 2. 数据库 → 后端 → 前端

```typescript
// 数据库查询结果 (snake_case)
const dbRow = {
  id: 'xxx',
  author_id: 'yyy',
  type: 'novel',
  likes_count: 10,
  created_at: '2025-01-25T10:00:00Z'
};

// ↓ 转换为 DTO (snake_case → camelCase)
const dto: FeedCardDTO = {
  id: 'xxx',
  authorId: 'yyy',
  type: 'novel',
  likesCount: 10,
  createdAt: '2025-01-25T10:00:00Z'
};

// ↓ 转换为前端类型
const feedCard: FeedCard = {
  id: 'xxx',
  type: 'novel',
  author: { id: 'yyy', handle: 'user', ... },
  stats: { likes: 10, ... },
  createdAt: '2025-01-25T10:00:00Z',
  novel: { ... }
};
```

## 📊 数据对齐表

### feed_cards 表

| 数据库字段 (snake_case) | DTO 字段 (camelCase) | 前端类型字段 | 说明 |
|------------------------|---------------------|-------------|------|
| `id` | `id` | `id` | UUID |
| `type` | `type` | `type` | novel/text/image/video/audio/ad/quote/repost |
| `author_id` | `authorId` | `author.id` | 作者 ID |
| `title` | `title` | `title` | 标题 |
| `content` | `content` | `content` | JSONB 内容 |
| `metadata` | `metadata` | `metadata` | JSONB 元数据 |
| `visibility` | `visibility` | - | 可见性 |
| `likes_count` | `likesCount` | `stats.likes` | 点赞数 |
| `comments_count` | `commentsCount` | `stats.replies` | 评论数 |
| `shares_count` | `sharesCount` | `stats.reposts` | 分享数 |
| `views_count` | `viewsCount` | `stats.views` | 浏览数 |
| `difficulty` | `difficulty` | `novel.difficulty` | 难度 (1-5) |
| `tags` | `tags` | `novel.tags` | 标签数组 |
| `created_at` | `createdAt` | `createdAt` | 创建时间 |
| `updated_at` | `updatedAt` | - | 更新时间 |

### profiles 表

| 数据库字段 | DTO 字段 | 前端类型字段 | 说明 |
|-----------|---------|-------------|------|
| `id` | `id` | `id` | UUID |
| `username` | `username` | `handle` | 用户名 |
| `display_name` | `displayName` | `displayName` | 显示名称 |
| `avatar_url` | `avatarUrl` | `avatar` | 头像 URL |
| `bio` | `bio` | `description` | 个人简介 |
| `level` | `level` | `level` | 等级 |
| `experience` | `experience` | - | 经验值 |
| `streak_days` | `streakDays` | - | 连续天数 |
| `last_active_at` | `lastActiveAt` | - | 最后活跃时间 |
| `created_at` | `createdAt` | - | 创建时间 |
| `updated_at` | `updatedAt` | - | 更新时间 |

### quests 表

| 数据库字段 | DTO 字段 | 前端类型字段 | 说明 |
|-----------|---------|-------------|------|
| `id` | `id` | `id` | UUID |
| `chapter_id` | `chapterId` | `chapterId` | 章节 ID |
| `type` | `type` | `type` | vocabulary/grammar/comprehension/speaking/writing |
| `order_index` | `orderIndex` | - | 顺序索引 |
| `config` | `config` | `questions` | JSONB 配置 |
| `passing_score` | `passingScore` | `passingScore` | 及格分数 |
| `time_limit` | `timeLimit` | `timeLimit` | 时间限制(秒) |
| `created_at` | `createdAt` | - | 创建时间 |

### interactions 表

| 数据库字段 | DTO 字段 | 说明 |
|-----------|---------|------|
| `id` | `id` | UUID |
| `user_id` | `userId` | 用户 ID |
| `target_id` | `targetId` | 目标 ID |
| `target_type` | `targetType` | card/comment/chapter/quest |
| `type` | `type` | like/unlike/comment/reply/share/repost/bookmark/quote |
| `content` | `content` | 内容（评论时使用） |
| `created_at` | `createdAt` | 创建时间 |

## 🔧 核心功能

### 1. 统一响应格式

所有 API 返回统一的响应结构：

```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: ApiError;
  message?: string;
  timestamp: string;
}
```

### 2. 自动字段转换

```typescript
// 数据库 → DTO (snake_case → camelCase)
function dbFieldToDto<T>(dbRow: Record<string, any>): T {
  const dto: Record<string, any> = {};
  for (const [key, value] of Object.entries(dbRow)) {
    const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());
    dto[camelKey] = value;
  }
  return dto as T;
}

// DTO → 数据库 (camelCase → snake_case)
function dtoFieldToDb<T>(dto: Record<string, any>): T {
  const dbRow: Record<string, any> = {};
  for (const [key, value] of Object.entries(dto)) {
    const snakeKey = key.replace(/[A-Z]/g, (letter) => `_${letter.toLowerCase()}`);
    dbRow[snakeKey] = value;
  }
  return dbRow as T;
}
```

### 3. 中间件链

每个 API 请求都会经过以下中间件：

1. **CORS 中间件**: 处理跨域请求
2. **日志中间件**: 记录请求日志
3. **认证中间件**: 验证用户身份
4. **业务逻辑**: Service 层处理
5. **错误处理**: 统一错误响应
6. **响应日志**: 记录响应日志

### 4. 权限系统

```typescript
// 基础权限（所有登录用户）
const basicPermissions = [
  'create_post',
  'create_quest',
  'edit_profile'
];

// 高级权限（等级 >= 50）
const adminPermissions = [
  'admin',
  'delete_content',
  'manage_users'
];
```

## 🚀 部署架构

```
┌─────────────────────────────────────────┐
│            Vercel Edge Network           │
│         (全球 CDN + 自动扩展)              │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│         Next.js API Routes               │
│      (Serverless Functions)              │
│  ├─ 自动 HTTPS                            │
│  ├─ 环境变量管理                          │
│  └─ 日志监控                              │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│         Supabase PostgreSQL              │
│      (托管数据库 + 认证)                   │
│  ├─ Row Level Security                   │
│  ├─ 自动备份                              │
│  └─ 实时订阅                              │
└─────────────────────────────────────────┘
```

## 📱 多端支持

### Web 应用
```typescript
const response = await fetch('/api/feed', {
  headers: { 'Authorization': `Bearer ${token}` }
});
```

### 微信小程序
```javascript
wx.request({
  url: 'https://your-domain.vercel.app/api/feed',
  header: { 'Authorization': 'Bearer ' + token }
});
```

### iOS/Android
```swift
// iOS
let request = URLRequest(url: URL(string: "https://your-domain.vercel.app/api/feed")!)
request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
```

## ✅ 最佳实践

1. **RESTful 设计**: 遵循 REST 规范
2. **统一响应**: 所有 API 返回统一格式
3. **错误处理**: 详细的错误码和错误信息
4. **字段对齐**: 数据库、DTO、前端三层对齐
5. **类型安全**: 完整的 TypeScript 类型定义
6. **权限控制**: 细粒度的权限系统
7. **日志记录**: 完整的请求/响应日志
8. **CORS 支持**: 支持多端跨域访问
9. **可扩展性**: 易于添加新功能
10. **文档完善**: 完整的 API 文档

## 🔮 未来扩展

1. **GraphQL 支持**: 提供 GraphQL API
2. **WebSocket**: 实时通知和消息
3. **缓存层**: Redis 缓存热门数据
4. **搜索引擎**: Elasticsearch 全文搜索
5. **AI 集成**: AI 评分和推荐系统
6. **微服务**: 拆分为独立的微服务
7. **监控告警**: APM 性能监控
8. **AB 测试**: 功能灰度发布

## 📝 总结

这套后端架构具有以下特点：

✅ **标准化**: RESTful API + 统一响应格式  
✅ **类型安全**: 完整的 TypeScript 类型系统  
✅ **数据对齐**: 数据库、DTO、前端三层字段对齐  
✅ **多端支持**: Web、小程序、App 通用  
✅ **可维护**: 清晰的分层架构  
✅ **可扩展**: 易于添加新功能  
✅ **高性能**: Vercel Edge + Supabase  
✅ **安全可靠**: 认证、权限、RLS  

现在你可以直接部署到 Vercel，所有 API 都可以被不同的前端应用调用！🎉

